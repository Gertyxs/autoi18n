# è‡ªåŠ¨å›½é™…åŒ–æ–¹æ¡ˆæ¢ç©¶

> [å¶å…´èƒœ](https://github.com/Gertyxs)/ 2021-8-30

## å‰è¨€

1. ä¸ºä»€ä¹ˆè¦åšå›½é™…åŒ–è‡ªåŠ¨åŒ–ï¼Ÿ
2. å›½é™…åŒ–è‡ªåŠ¨åŒ–æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
3. æ€ä¹ˆåšå›½é™…åŒ–è‡ªåŠ¨åŒ–ï¼Ÿ

è®©æˆ‘ä»¬å¸¦ç€è¿™äº›é—®é¢˜è¿›å…¥æœ¬æ–‡çš„æ¢ç´¢ã€‚

## ä¸€ã€ä¸ºä»€ä¹ˆè¦åšå›½é™…åŒ–è‡ªåŠ¨åŒ–ï¼Ÿ

**åœºæ™¯1ï¼š**

å‡å¦‚è¯´ä½ å…¬å¸æœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œè¯¥é¡¹ç›®å·²ç»è¿­ä»£äº†äº”å…­å¹´ï¼Œé¡µé¢æœ‰ä¸€ä¸¤ç™¾ä¸ªï¼Œæœ‰ä¸€å¤©ï¼Œä½ é¢†å¯¼è¯´è¦åšå›½é™…åŒ–ï¼Œè®©ä½ è¯„ä¼°ä¸€ä¸‹å¼€å‘æ—¶é—´ã€‚æ­¤æ—¶æˆ‘çŒœä½ çš„å¿ƒæƒ…æ˜¯è¿™æ ·çš„ï¼š

![](http://img.doutula.com/production/uploads/image/2017/10/15/20171015037242_gNfleB.jpg)

å†…å¿ƒæ—ç™½ï¼š

ä¸å¹²äº†ï¼Ÿ

è¾èŒï¼Ÿ

æƒ³æƒ³è´«ç©·çš„è‡ªå·±ï¼Œè¿˜æ˜¯ç¨³ç¨³çš„åŠ ç­å§ï¼

é—®é¢˜æš´éœ²å‡ºï¼šæ‰‹åŠ¨å›½é™…åŒ–æ¯ç‡¥æ— å‘³ï¼Œå·¥ä½œé‡å¤§ï¼Œå®¹æ˜“æ¼æ‰å›½é™…åŒ–å­—æ®µï¼Œå¼€å‘æ•ˆç‡ä½ä¸‹ã€‚

**åœºæ™¯2**

å¦‚æœæ‰‹åŠ¨åšå›½é™…åŒ–åŸºæœ¬ä¸Šéƒ½è¦ä¿®æ”¹æºç ï¼Œè¢«æ”¹è¿‡çš„æºç åŸºæœ¬ä¸Šè¿ä¸€ä¸ªä¸­æ–‡æ ‡è¯†ç¬¦éƒ½æ‰¾ä¸åˆ°ï¼Œæœ‰æ—¶å€™æ‰¾ä¸€ä¸ªæŒ‰é’®éƒ½å¾—å…ˆåˆ°å›½é™…åŒ–èµ„æºæ–‡ä»¶æ‰¾åˆ°å¯¹åº”çš„keyï¼Œè¿™ç§ä¾µå…¥å¼çš„æ‰‹åŠ¨å›½é™…åŒ–å¯¼è‡´åŠ å¤§äº†ç»´æŠ¤æˆæœ¬ã€‚

åŸºäºä»¥ä¸Šä¸¤ä¸ªåœºæ™¯ï¼š

**æˆ‘ä»¬è¦åšå›½é™…åŒ–è‡ªåŠ¨åŒ–ï¼ï¼ï¼**

## äºŒã€å›½é™…åŒ–è‡ªåŠ¨åŒ–æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1. é«˜æ•ˆçš„æé«˜äº†å¼€å‘æ•ˆç‡
2. è‡ªåŠ¨æå–å›½é™…åŒ–å­—æ®µä¸æ˜“é—æ¼
3. å¯ä»¥é€šè¿‡æ— ä¾µå…¥å¼å›½é™…åŒ–è‡ªåŠ¨åŒ–ä½¿é¡¹ç›®æ˜“äºç»´æŠ¤

## ä¸‰ã€è¯¥æ€ä¹ˆåšå›½é™…åŒ–è‡ªåŠ¨åŒ–

### 1ã€æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ€ä¹ˆåšå›½é™…åŒ–è‡ªåŠ¨åŒ–

1. è‡ªåŠ¨æå–ä»£ç ä¸­çš„å›½é™…åŒ–å­—æ®µ
2. è‡ªåŠ¨ç¿»è¯‘ä»£ç ä¸­çš„å›½é™…åŒ–å­—æ®µï¼ˆç”±äºè°·æ­Œå’Œç™¾åº¦ç¿»è¯‘apiè°ƒç”¨æœ‰æ¬¡æ•°å’Œå­—æ•°é™åˆ¶ï¼Œè€Œä¸”ç¿»è¯‘ä¸ç†æƒ³ï¼‰æˆ‘ä»¬é‡‡ç”¨æ‰‹åŠ¨ç¿»è¯‘
3. è‡ªåŠ¨æ›¿æ¢ä»£ç ä¸­çš„å›½é™…åŒ–å­—æ®µ

> å›½é™…åŒ–å¤„ç†çš„æ˜¯ä»£ç ä¸­çš„ä¸­æ–‡å­—ç¬¦ï¼Œä¸­æ–‡å­—ç¬¦åœ¨ä»£ç ä¸­å…¶å®å°±æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬å½’æ ¹ç»“åº•å°±æ˜¯è¦å¤„ç†ä»£ç ä¸­çš„å­—ç¬¦ä¸²ã€‚

### 2ã€è·å–é¡¹ç›®çš„ä»£ç 

å¯ä»¥é€šè¿‡[glob](https://github.com/isaacs/node-glob#readme)è·å–æ‰€ä»¥ä»£ç æ–‡ä»¶ç„¶åé€šè¿‡`fs.readFileSync`æ¨¡å—æ¥è¯»å–æºç 

```js
const getSourceFiles = () => {
  const sourceFiles = glob.sync(`${curEntry}/**/*.{js,ts,vue,jsx,tsx}`, { ignore: [] })
  return targetFiles
}
// è·å–æ‰€æœ‰å…¥å£æ–‡ä»¶è·¯åŠ²
let targetFiles = getSourceFiles()
// å¼€å§‹è¯»å–æ–‡ä»¶è¿›è¡Œæ“ä½œ
for (let i = 0; i < targetFiles.length; i++) {
  const sourceCode = fs.readFileSync(targetFiles[i].filePath, 'utf8')
  const code = transform({ code: sourceCode, targetFile: targetFiles[i], options, messages })
}
```

è¯»å–åˆ°æºç åæˆ‘ä»¬å°±å¯ä»¥å¯¹å…¶è¿›è¡Œæ“ä½œäº†

### 3ã€ä»£ç ä¸­çš„å­—ç¬¦è¯¥æ€ä¹ˆå¤„ç†

#### 3.1 JavaScriptä¸­çš„å­—ç¬¦

```js
let str1 = 'æˆ‘æ˜¯å­—ç¬¦ä¸²1'
let str2 = "æˆ‘æ˜¯å­—ç¬¦ä¸²2"
let str3 = `æˆ‘æ˜¯å­—ç¬¦ä¸²3`
```

å¯¹äº`JavaScript`ï¼Œåªè¦å¤„ç†å¸¦æœ‰ä¸­æ–‡çš„å­—ç¬¦ä¸²å°±è¡Œäº†ï¼Œå¤„ç†è¿™äº›å­—ç¬¦æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`RegExp`åŒ¹é…æˆ–è€…[bable ast](https://astexplorer.net/)æ ‘è§£æ`JavaScript`,åœ¨[autoi8n](https://github.com/Gertyxs/autoi18n)ä¸­æˆ‘ä½¿ç”¨`ast`è§£æè¿›è¡Œå¤„ç†ã€‚

```js
const babel = require('@babel/core')
const generate = require('@babel/generator').default
const traverse = require('@babel/traverse').default

const  ast = babel.parseSync(code, transformOptions)
const makeVisitor = () => {
  return {
    TemplateLiteral(path) {
      // ...
    },
    StringLiteral(path) {
      // ...
    },
    DirectiveLiteral(path) {
     // ...
    },
    JSXText(path) {
      // ...
    },
    JSXAttribute(path) {
      // ...
    }
  }
}
const visitor = makeVisitor({ code, options, messages, ext, codeType })
traverse(ast, visitor)
const output = generate(ast, code)
```

#### 3.2 vueæ–‡ä»¶ä¸­çš„å­—ç¬¦

```vue
<template>
	<div attr1="æˆ‘æ˜¯é™æ€å±æ€§" :attr2="æˆ‘æ˜¯åŠ¨æ€å±æ€§">
    {{'æˆ‘æ˜¯vueå†…å®¹'}}
    æˆ‘æ˜¯æ ‡ç­¾é™æ€å†…å®¹
  </div>
</template>
<script>
	let str1 = 'æˆ‘æ˜¯å­—ç¬¦ä¸²1'
  let str2 = "æˆ‘æ˜¯å­—ç¬¦ä¸²2"
  let str3 = `æˆ‘æ˜¯å­—ç¬¦ä¸²3`
</script>
```

åœ¨`vue`å•æ–‡ä»¶ç»„ç»‡ä¸­å¯ä»¥çœ‹å‡ºæˆ‘ä»¬åªè¦å¤„ç†`template`ä»¥åŠ`script`é‡Œé¢çš„ä»£ç å³å¯

å¯¹äº`vue`å•æ–‡ä»¶ç»„ä»¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„è§£æåº“[vue-template-compiler](https://github.com/vuejs/vue/tree/dev/packages/vue-template-compiler#readme)æå–`template`å’Œ`JavaScript`

```js
const compiler = require('vue-template-compiler')
const sfc = compiler.parseComponent(code, { pad: 'space', deindent: false })
const { template, script, styles, customBlocks } = sfc
```

ä¸Šé¢å°±æŠŠ`vue`å•æ–‡ä»¶ç»„ç»‡åˆ†æˆäº†`template`å’Œ`JavaScript`äº†ã€‚

**template**

å¯¹äº`template`æˆ‘ä»¬åªéœ€è¦å¤„ç†æ ‡ç­¾çš„é™æ€å±æ€§ã€åŠ¨æ€å±æ€§å’Œæ ‡ç­¾å†…å®¹å³å¯,å¤„ç†è¿™äº›å­—ç¬¦æˆ‘ä»¬å¯ä»¥ä½¿ç”¨[parse5](https://www.npmjs.com/package/parse5)å»è§£ææ ‡ç­¾æˆ–è€…ç”¨`RegExp`åŒ¹é…ï¼Œåœ¨[autoi8n](https://github.com/Gertyxs/autoi18n)ä¸­æˆ‘ä½¿ç”¨`RegExp`åŒ¹é…ï¼Œå¦‚æœ‰éœ€è¦åæœŸä¼šé‡‡ç”¨æ ‡ç­¾è§£æå™¨å¤„ç†ã€‚

```js
const matchTagAttr = ({ code }) => {
  code = code.replace(/(<[^\/\s]+)([^<>]+)(\/?>)/gm, (match, startTag, attrs, endTag) => {
  	return code
  })
  return code
}
const matchTagContent = ({ code, options, ext, codeType, messages }) => {
  code = code.replace(/(>)([^><]*[\u4e00-\u9fa5]+[^><]*)(<)/gm, (match, beforeSign, value, afterSign) => {
  	return code
  })
  return code
}
```

**JavaScript**

åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»è®²è§£è¿‡`JavaScript`çš„å¤„ç†äº†ï¼Œåœ¨è¿™é‡Œä¸å†æ•–è¿°ã€‚

#### 3.3 React jsxä¸­çš„å­—ç¬¦

```jsx
const render = () => {
  return (
    <div>
      <div attr="æˆ‘æ˜¯é™æ€å±æ€§" attr2={'æˆ‘æ˜¯åŠ¨æ€å±æ€§'}>
        {'æˆ‘æ˜¯reactå†…å®¹'}
        æˆ‘æ˜¯æ ‡ç­¾é™æ€å†…å®¹
      </div>
    </div>
  )
}
```

åœ¨`react`ä¸­ï¼Œæˆ‘ä»¬åŒæ ·å¤„ç†`JavaScript`å­—ç¬¦ä¸²ï¼Œ`jsx`æ ‡ç­¾å±æ€§å’Œæ ‡ç­¾å†…å®¹ï¼Œç”±äº`jsx`æœ¬èº«æ”¯æŒ[bable ast](https://astexplorer.net/)è§£ææ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨`ast`è¿›è¡Œè§£æã€‚

**ä»£ç åˆ†æå®Œæˆ**

é€šè¿‡ä¸Šé¢å¯¹jsã€vueã€JavaScriptã€çš„ä»£ç åˆ†æï¼Œæˆ‘ä»¬å·²ç»åŒ¹é…åˆ°æ‰€æœ‰éœ€è¦åšå›½é™…åŒ–çš„å­—ç¬¦ï¼Œæˆ‘ä»¬å†æŠŠå¯¹åº”çš„å­—ç¬¦æŠ½å‡ºç”Ÿæˆä¸€ä¸ªmessageså¯¹è±¡å†™è¿›æ–‡ä»¶å°±å®Œæˆäº†èµ„æºæ–‡ä»¶çš„ç”Ÿæˆäº†ã€‚ç„¶åæŠŠå¯¹åº”çš„å­—ç¬¦æ›¿æ¢æˆæˆ‘ä»¬å›½é™…åŒ–è®¾ç½®çš„æ–¹æ³•å°±å¤§åŠŸå‘Šæˆäº†ã€‚

#### 3.4 webpack loader å®ç°æ— ä¾µå…¥å¼çš„è‡ªåŠ¨å›½å›½é™…åŒ–

å®ç°äº†å¯¹ä»£ç å¤„ç†ä¹‹åï¼Œè¿˜å¯ä»¥åœ¨webpack loaderé‡Œé¢æŠŠæºç ä¼ è¿›æ¥è¿›è¡Œæ— ä¾µå…¥å¼å¤„ç†

```js
const path = require('path')
const fs = require('fs')
const mergeIi8nConfig = require('../cli/utils/mergeIi8nConfig');
const { transform } = require('../core/index')
let messages = {}

module.exports = function (source) {
  const configOptions = mergeIi8nConfig()
  let targetFile = { ext: path.extname(this.resourcePath), filePath: this.resourcePath }
  source = transform({ code: source, targetFile, options: configOptions, messages })
  messages = {}
  return source
}
```

webpack loader é…ç½® 

```js
{
  enforce: 'pre', // æ­¤é¡¹ä¸€å®šè¦åŠ ä¸Š ä¼˜å…ˆæ‰§è¡Œçš„loader
  test: /\.(js|mjs|jsx|ts|tsx)$/,
  use: [
  {
      loader: 'autoi18n',
      options: {}
  }],
  exclude: /node_modules/
}
```



## æ€»ç»“

æ•´ç¯‡æ–‡ç« ä¸»è¦å›´ç»•æ€ä¹ˆå®ç°é¡¹ç›®å›½é™…åŒ–è‡ªåŠ¨åŒ–ï¼Œå¸Œæœ›æœ¬æ–‡å¯ä»¥ç»™ä½ å¸¦æ¥å›½é™…åŒ–è‡ªåŠ¨åŒ–çš„æ€è·¯ï¼Œæ€»çš„æ¥è¯´å›½é™…åŒ–è‡ªåŠ¨åŒ–å°±æ˜¯å¤„ç†ä»£ç ä¸­çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥é€šè¿‡ä»£ç è§£æå™¨æˆ–è€…æ­£åˆ™å»åŒ¹é…å¯¹åº”çš„å­—ç¬¦ï¼Œç„¶åæŠ½å–å‡ºæ¥æ›¿æ¢æˆå¯¹åº”çš„å›½é™…åŒ–keyï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ã€‚



åˆ†äº«ä¸€ä¸ªå›½é™…åŒ–è‡ªåŠ¨åŒ–çš„åº“[autoi18n](https://github.com/Gertyxs/autoi18n)

é¡¹ç›®è¿˜åœ¨å®Œå–„ä¸­ï¼Œæ¬¢è¿å¤§å®¶prï¼Œå¦‚æœä½ è§‰å¾—ä¸é”™ä¹Ÿæ¬¢è¿ç»™ä¸ªstart ğŸ˜„ğŸ˜„ğŸ˜„